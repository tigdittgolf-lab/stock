<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Loop Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 3px; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîß Test API Loop Fix</h1>
    
    <div class="test-section info">
        <h2>üîç Probl√®me R√©solu</h2>
        <p><strong>Erreur 508 (Loop Detected)</strong> caus√©e par des API routes qui s'appelaient elles-m√™mes</p>
        <p><strong>Solution appliqu√©e :</strong> 18 fichiers corrig√©s pour pointer vers localhost:3005</p>
    </div>

    <div class="test-section">
        <h2>üß™ Test des API Routes</h2>
        <button onclick="testProformas()">Test Proformas</button>
        <button onclick="testDeliveryNotes()">Test Delivery Notes</button>
        <button onclick="testInvoices()">Test Invoices</button>
        <button onclick="testAllAPIs()">Test Toutes les APIs</button>
        <div id="testResult" class="result"></div>
    </div>

    <div class="test-section success">
        <h2>‚úÖ URLs Corrig√©es</h2>
        <p><strong>Avant :</strong> https://frontend-iota-six-72.vercel.app/api/... (boucle)</p>
        <p><strong>Apr√®s :</strong> http://localhost:3005/api/... (backend direct)</p>
    </div>

    <script>
        async function testAPI(endpoint, name) {
            try {
                console.log(`üß™ Testing ${name}...`);
                const response = await fetch(`http://localhost:3001${endpoint}`, {
                    headers: {
                        'X-Tenant': '2025_bu01'
                    }
                });
                
                const data = await response.json();
                
                return {
                    name,
                    endpoint,
                    status: response.status,
                    success: response.ok,
                    data: data,
                    error: response.ok ? null : `HTTP ${response.status}`
                };
            } catch (error) {
                return {
                    name,
                    endpoint,
                    status: 'ERROR',
                    success: false,
                    error: error.message
                };
            }
        }

        async function testProformas() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = 'üîÑ Test des proformas...';
            
            const result = await testAPI('/api/sales/proformas', 'Proformas');
            displayResult([result]);
        }

        async function testDeliveryNotes() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = 'üîÑ Test des bons de livraison...';
            
            const result = await testAPI('/api/sales/delivery-notes', 'Delivery Notes');
            displayResult([result]);
        }

        async function testInvoices() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = 'üîÑ Test des factures...';
            
            const result = await testAPI('/api/sales/invoices', 'Invoices');
            displayResult([result]);
        }

        async function testAllAPIs() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = 'üîÑ Test de toutes les APIs...';
            
            const apis = [
                { endpoint: '/api/sales/proformas', name: 'Proformas' },
                { endpoint: '/api/sales/delivery-notes', name: 'Delivery Notes' },
                { endpoint: '/api/sales/invoices', name: 'Invoices' },
                { endpoint: '/api/articles', name: 'Articles' },
                { endpoint: '/api/clients', name: 'Clients' },
                { endpoint: '/api/suppliers', name: 'Suppliers' }
            ];
            
            const results = [];
            for (const api of apis) {
                const result = await testAPI(api.endpoint, api.name);
                results.push(result);
            }
            
            displayResult(results);
        }

        function displayResult(results) {
            const resultDiv = document.getElementById('testResult');
            
            let html = '<h4>üìä R√©sultats des Tests :</h4>';
            
            let successCount = 0;
            let errorCount = 0;
            
            results.forEach(result => {
                const statusClass = result.success ? 'success' : 'error';
                const icon = result.success ? '‚úÖ' : '‚ùå';
                
                if (result.success) {
                    successCount++;
                } else {
                    errorCount++;
                }
                
                html += `
                    <div class="${statusClass}" style="margin: 10px 0; padding: 10px; border-radius: 5px;">
                        ${icon} <strong>${result.name}</strong><br>
                        üìç Endpoint: ${result.endpoint}<br>
                        üìä Status: ${result.status}<br>
                        ${result.success ? 
                            `‚úÖ Donn√©es re√ßues: ${Array.isArray(result.data?.data) ? result.data.data.length + ' √©l√©ments' : 'OK'}` :
                            `‚ùå Erreur: ${result.error}`
                        }
                        ${result.status === 508 ? '<br><strong>‚ö†Ô∏è BOUCLE D√âTECT√âE - V√©rifiez la configuration</strong>' : ''}
                    </div>
                `;
            });
            
            // R√©sum√©
            html += `
                <div class="${errorCount === 0 ? 'success' : 'info'}" style="margin: 15px 0; padding: 15px; border-radius: 5px;">
                    <h4>üìà R√©sum√©</h4>
                    <p>‚úÖ Succ√®s: ${successCount}</p>
                    <p>‚ùå Erreurs: ${errorCount}</p>
                    ${errorCount === 0 ? 
                        '<p><strong>üéâ Toutes les APIs fonctionnent correctement !</strong></p>' :
                        '<p><strong>‚ö†Ô∏è Certaines APIs ont encore des probl√®mes</strong></p>'
                    }
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        // Auto-test des proformas au chargement
        window.onload = function() {
            setTimeout(testProformas, 1000);
        };
    </script>
</body>
</html>