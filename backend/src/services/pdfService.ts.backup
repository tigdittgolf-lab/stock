import { jsPDF } from 'jspdf';
import { numberToWords, amountInWords } from '../utils/numberToWords.js';
import { formatAmount, formatNumber, formatPercentage, formatQuantity } from '../utils/numberFormatter.js';
import { CompanyService, CompanyInfo } from './companyService.js';

// CompanyInfo interface is now imported from companyService.ts

interface InvoiceData {
  nfact: number;
  date_fact: string;
  client: {
    raison_sociale: string;
    adresse?: string;
    nif?: string;
    rc?: string;
  };
  detail_fact: Array<{
    article: {
      designation: string;
      narticle: string;
    };
    qte: number;
    prix: number;
    tva: number;
    total_ligne: number;
  }>;
  montant_ht: number;
  tva: number;
  timbre: number;
  autre_taxe: number;
}

interface DeliveryNoteData {
  nfact: number;
  date_fact: string;
  client: {
    raison_sociale: string;
    adresse?: string;
  };
  detail_bl: Array<{
    article: {
      designation: string;
      narticle: string;
    };
    qte: number;
    prix?: number;
    tva?: number;
    total_ligne?: number;
  }>;
  montant_ht: number;    // ‚Üê Rendu obligatoire
  tva: number;           // ‚Üê Rendu obligatoire  
  montant_ttc: number;   // ‚Üê Rendu obligatoire
  timbre?: number;
  autre_taxe?: number;
}

export class PDFService {
  private companyInfo: CompanyInfo | null = null;

  constructor(companyInfo?: CompanyInfo) {
    this.companyInfo = companyInfo || null;
  }

  /**
   * Get company info (from database or fallback to constructor)
   */
  private async getCompanyInfo(tenant?: string): Promise<CompanyInfo> {
    if (!this.companyInfo) {
      this.companyInfo = await CompanyService.getCompanyInfo(tenant);
    }
    return this.companyInfo;
  }

  /**
   * Generate invoice PDF
   */
  async generateInvoice(invoiceData: InvoiceData, tenant?: string): Promise<jsPDF> {
    const doc = new jsPDF();
    let yPos = 20;

    // Get company info from database for the specific tenant
    const companyInfo = await this.getCompanyInfo(tenant);

    // Header - Title
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.text('FACTURE', 105, yPos, { align: 'center' });
    yPos += 10;

    // Line under title
    doc.setLineWidth(0.5);
    doc.line(20, yPos, 190, yPos);
    yPos += 15;

    // Invoice info et Client info (c√¥t√© droit) 
    let rightSideY = yPos;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Facture N: ${invoiceData.nfact}`, 140, rightSideY);
    rightSideY += 5;
    doc.text(`Date: ${new Date(invoiceData.date_fact).toLocaleDateString('fr-FR')}`, 140, rightSideY);
    rightSideY += 10; // Espacement avant les infos client
    
    // Client info (c√¥t√© droit, en dessous de la date)
    doc.setFont('helvetica', 'bold');
    doc.text('Client:', 140, rightSideY);
    rightSideY += 5;
    doc.setFont('helvetica', 'normal');
    doc.text(invoiceData.client.raison_sociale, 140, rightSideY);
    rightSideY += 5;

    if (invoiceData.client.adresse) {
      doc.text(invoiceData.client.adresse, 140, rightSideY);
      rightSideY += 5;
    }

    if (invoiceData.client.nif) {
      doc.text(`NIF: ${invoiceData.client.nif}`, 140, rightSideY);
      rightSideY += 5;
    }
    
    // Company info (c√¥t√© gauche) - Limiter la largeur pour √©viter chevauchement avec droite
    yPos = 45; // Position fixe pour les infos entreprise
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    // Limiter le texte pour √©viter d√©bordement sur la droite
    const companyName = companyInfo.name.length > 35 ? companyInfo.name.substring(0, 35) + '...' : companyInfo.name;
    doc.text(companyName, 20, yPos);
    yPos += 5;
    
    // Add domain of activity if available
    if (companyInfo.domaine_activite) {
      doc.setFontSize(8);
      doc.setFont('helvetica', 'italic');
      const domaine = companyInfo.domaine_activite.length > 40 ? companyInfo.domaine_activite.substring(0, 40) + '...' : companyInfo.domaine_activite;
      doc.text(domaine, 20, yPos);
      yPos += 4;
      if (companyInfo.sous_domaine) {
        const sousDomaine = companyInfo.sous_domaine.length > 40 ? companyInfo.sous_domaine.substring(0, 40) + '...' : companyInfo.sous_domaine;
        doc.text(sousDomaine, 20, yPos);
        yPos += 4;
      }
    }
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    // Limiter l'adresse pour √©viter d√©bordement
    const address = companyInfo.address.length > 45 ? companyInfo.address.substring(0, 45) + '...' : companyInfo.address;
    doc.text(address, 20, yPos);
    yPos += 5;
    doc.text(`T√©l: ${companyInfo.phone}`, 20, yPos);
    yPos += 5;

    if (companyInfo.tel_port) {
      doc.text(`Mobile: ${companyInfo.tel_port}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.email) {
      const email = companyInfo.email.length > 35 ? companyInfo.email.substring(0, 35) + '...' : companyInfo.email;
      doc.text(`Email: ${email}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.nif || companyInfo.ident_fiscal) {
      const nif = (companyInfo.nif || companyInfo.ident_fiscal);
      doc.text(`NIF: ${nif}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.rc) {
      doc.text(`RC: ${companyInfo.rc}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.art) {
      doc.text(`Art: ${companyInfo.art}`, 20, yPos);
      yPos += 5;
    }

    // Sauvegarder la position finale des infos entreprise
    let companyEndY = yPos;

    // Table header - Position apr√®s les infos entreprise ET client (c√¥t√© droit)
    // Prendre la position la plus basse entre infos entreprise et infos client
    yPos = Math.max(companyEndY + 15, rightSideY + 10);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.text('Code', 20, yPos);
    doc.text('Designation', 45, yPos);
    doc.text('Qte', 105, yPos, { align: 'center' });
    doc.text('P.U.', 130, yPos, { align: 'center' });
    doc.text('TVA', 155, yPos, { align: 'center' });
    doc.text('Total', 180, yPos, { align: 'center' });

    // Line under header
    yPos += 2;
    doc.line(20, yPos, 190, yPos);
    yPos += 5;

    // Table rows
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);

    invoiceData.detail_fact.forEach((item) => {
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      }

      doc.text(item.article.narticle.substring(0, 8), 20, yPos);
      doc.text(item.article.designation.substring(0, 25), 45, yPos);
      doc.text(formatQuantity(item.qte), 110, yPos, { align: 'right' });
      doc.text(formatNumber(item.prix), 140, yPos, { align: 'right' });
      doc.text(formatPercentage(item.tva), 165, yPos, { align: 'right' });
      doc.text(formatNumber(item.total_ligne), 190, yPos, { align: 'right' });

      yPos += 6;
    });

    // Totals section
    yPos += 10;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');

    const totalTTC = invoiceData.montant_ht + invoiceData.tva + invoiceData.timbre + invoiceData.autre_taxe;

    doc.text('Sous-total HT:', 120, yPos);
    doc.text(formatAmount(invoiceData.montant_ht), 190, yPos, { align: 'right' });
    yPos += 6;

    doc.text('TVA:', 120, yPos);
    doc.text(formatAmount(invoiceData.tva), 190, yPos, { align: 'right' });
    yPos += 6;

    if (invoiceData.timbre > 0) {
      doc.text('Timbre:', 120, yPos);
      doc.text(formatAmount(invoiceData.timbre), 190, yPos, { align: 'right' });
      yPos += 6;
    }

    if (invoiceData.autre_taxe > 0) {
      doc.text('Autres taxes:', 120, yPos);
      doc.text(formatAmount(invoiceData.autre_taxe), 190, yPos, { align: 'right' });
      yPos += 6;
    }

    // Total TTC
    yPos += 2;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('TOTAL TTC:', 120, yPos);
    doc.text(formatAmount(totalTTC), 190, yPos, { align: 'right' });

    // Amount in words - CONFORME √Ä LA R√âGLEMENTATION
    yPos += 15;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    
    // Ligne de s√©paration avant le montant en lettres
    doc.line(20, yPos - 5, 190, yPos - 5);
    
    doc.text('Arr√™t√© la pr√©sente facture √† la somme de :', 20, yPos);
    yPos += 12; // ‚Üê Plus d'espace (√©tait 8)

    const amountWords = numberToWords(totalTTC);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    
    // Encadrer le montant en lettres avec plus d'espace
    const textWidth = doc.getTextWidth(amountWords);
    const boxWidth = Math.min(textWidth + 16, 170); // ‚Üê Plus de padding (√©tait 10)
    const boxHeight = 16; // ‚Üê Plus haut (√©tait 12)
    
    doc.rect(20, yPos - 10, boxWidth, boxHeight); // ‚Üê Ajust√© pour la nouvelle hauteur
    doc.text(amountWords, 28, yPos - 2, { // ‚Üê Plus de marge √† gauche (√©tait 25)
      maxWidth: 160
    });
    
    yPos += 18; // ‚Üê Plus d'espace apr√®s le cadre (√©tait 10)

    // Signature
    yPos += 20;
    doc.setFont('helvetica', 'normal');
    doc.text('Signature et Cachet', 140, yPos);

    return doc;
  }

  /**
   * Generate delivery note PDF (format complet)
   */
  async generateDeliveryNote(deliveryData: DeliveryNoteData, tenant?: string): Promise<jsPDF> {
    const doc = new jsPDF();
    let yPos = 20;

    // DEBUG: Log des donn√©es re√ßues
    console.log(`üîç PDF Service - Donn√©es re√ßues pour generateDeliveryNote:`, {
      montant_ht: deliveryData.montant_ht,
      tva: deliveryData.tva,
      montant_ttc: deliveryData.montant_ttc,
      timbre: deliveryData.timbre,
      autre_taxe: deliveryData.autre_taxe,
      dataType_montant_ht: typeof deliveryData.montant_ht,
      dataType_tva: typeof deliveryData.tva,
      dataType_montant_ttc: typeof deliveryData.montant_ttc
    });

    // Debug logs pour v√©rifier les donn√©es re√ßues
    console.log(`üîç PDF Service - Donn√©es re√ßues pour BL:`, {
      montant_ht: deliveryData.montant_ht,
      tva: deliveryData.tva,
      montant_ttc: deliveryData.montant_ttc,
      timbre: deliveryData.timbre,
      autre_taxe: deliveryData.autre_taxe
    });

    // Get company info from database for the specific tenant
    const companyInfo = await this.getCompanyInfo(tenant);

    // Header - Title
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.text('BON DE LIVRAISON', 105, yPos, { align: 'center' });
    yPos += 10;

    // Line under title
    doc.setLineWidth(0.5);
    doc.line(20, yPos, 190, yPos);
    yPos += 15;

    // BL info et Client info (c√¥t√© droit) 
    let rightSideY = yPos;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`BL N: ${deliveryData.nfact}`, 140, rightSideY);
    rightSideY += 5;
    doc.text(`Date: ${new Date(deliveryData.date_fact).toLocaleDateString('fr-FR')}`, 140, rightSideY);
    rightSideY += 10; // Espacement avant les infos client
    
    // Client info (c√¥t√© droit, en dessous de la date)
    doc.setFont('helvetica', 'bold');
    doc.text('Client:', 140, rightSideY);
    rightSideY += 5;
    doc.setFont('helvetica', 'normal');
    doc.text(deliveryData.client.raison_sociale, 140, rightSideY);
    rightSideY += 5;

    if (deliveryData.client.adresse) {
      doc.text(deliveryData.client.adresse, 140, rightSideY);
      rightSideY += 5;
    }
    
    // Company info (c√¥t√© gauche) - Limiter la largeur pour √©viter chevauchement avec droite
    yPos = 45; // Position fixe pour les infos entreprise
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    // Limiter le texte pour √©viter d√©bordement sur la droite
    const companyName = companyInfo.name.length > 35 ? companyInfo.name.substring(0, 35) + '...' : companyInfo.name;
    doc.text(companyName, 20, yPos);
    yPos += 5;
    
    // Add domain of activity if available
    if (companyInfo.domaine_activite) {
      doc.setFontSize(8);
      doc.setFont('helvetica', 'italic');
      const domaine = companyInfo.domaine_activite.length > 40 ? companyInfo.domaine_activite.substring(0, 40) + '...' : companyInfo.domaine_activite;
      doc.text(domaine, 20, yPos);
      yPos += 4;
      if (companyInfo.sous_domaine) {
        const sousDomaine = companyInfo.sous_domaine.length > 40 ? companyInfo.sous_domaine.substring(0, 40) + '...' : companyInfo.sous_domaine;
        doc.text(sousDomaine, 20, yPos);
        yPos += 4;
      }
    }
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    // Limiter l'adresse pour √©viter d√©bordement
    const address = companyInfo.address.length > 45 ? companyInfo.address.substring(0, 45) + '...' : companyInfo.address;
    doc.text(address, 20, yPos);
    yPos += 5;
    doc.text(`T√©l: ${companyInfo.phone}`, 20, yPos);
    yPos += 5;

    if (companyInfo.tel_port) {
      doc.text(`Mobile: ${companyInfo.tel_port}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.email) {
      const email = companyInfo.email.length > 35 ? companyInfo.email.substring(0, 35) + '...' : companyInfo.email;
      doc.text(`Email: ${email}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.nif || companyInfo.ident_fiscal) {
      const nif = (companyInfo.nif || companyInfo.ident_fiscal);
      doc.text(`NIF: ${nif}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.rc) {
      doc.text(`RC: ${companyInfo.rc}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.art) {
      doc.text(`Art: ${companyInfo.art}`, 20, yPos);
      yPos += 5;
    }

    // Sauvegarder la position finale des infos entreprise
    let companyEndY = yPos;

    // Table header - Position apr√®s les infos entreprise ET client (c√¥t√© droit)
    // Prendre la position la plus basse entre infos entreprise et infos client
    yPos = Math.max(companyEndY + 15, rightSideY + 10);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.text('Code', 20, yPos);
    doc.text('Designation', 45, yPos);
    doc.text('Qte', 105, yPos, { align: 'center' });
    doc.text('P.U.', 130, yPos, { align: 'center' });
    doc.text('TVA', 155, yPos, { align: 'center' });
    doc.text('Total', 180, yPos, { align: 'center' });

    // Line under header
    yPos += 2;
    doc.line(20, yPos, 190, yPos);
    yPos += 5;

    // Table rows
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);

    deliveryData.detail_bl.forEach((item) => {
      if (yPos > 240) {
        doc.addPage();
        yPos = 20;
      }

      doc.text(item.article.narticle.substring(0, 8), 20, yPos);
      doc.text(item.article.designation.substring(0, 25), 45, yPos);
      doc.text(formatQuantity(item.qte), 110, yPos, { align: 'right' });
      
      if (item.prix) {
        doc.text(formatNumber(item.prix), 140, yPos, { align: 'right' });
      }
      
      if (item.tva) {
        doc.text(formatPercentage(item.tva), 165, yPos, { align: 'right' });
      }
      
      if (item.total_ligne) {
        doc.text(formatNumber(item.total_ligne), 190, yPos, { align: 'right' });
      }

      yPos += 6;
    });

    // Totals section (si les montants sont disponibles)
    if (deliveryData.montant_ht !== undefined) {
      yPos += 10;
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');

      // CORRECTION: Conversion num√©rique pour √©viter la concat√©nation de cha√Ænes
      let totalTTC = deliveryData.montant_ttc;
      if (totalTTC === undefined || totalTTC === null || isNaN(totalTTC)) {
        totalTTC = parseFloat(deliveryData.montant_ht?.toString() || '0') + 
                   parseFloat(deliveryData.tva?.toString() || '0') + 
                   parseFloat(deliveryData.timbre?.toString() || '0') + 
                   parseFloat(deliveryData.autre_taxe?.toString() || '0');
      }
      
      // S'assurer que totalTTC est un nombre valide
      totalTTC = parseFloat(totalTTC.toString()) || 0;

      console.log(`üîç PDF Service - Calcul totalTTC:`, {
        montant_ht: deliveryData.montant_ht || 0,
        tva: deliveryData.tva || 0,
        timbre: deliveryData.timbre || 0,
        autre_taxe: deliveryData.autre_taxe || 0,
        montant_ttc_from_data: deliveryData.montant_ttc,
        totalTTC_final: totalTTC
      });

      doc.text('Sous-total HT:', 120, yPos);
      doc.text(formatAmount(deliveryData.montant_ht || 0), 190, yPos, { align: 'right' });
      yPos += 6;

      doc.text('TVA:', 120, yPos);
      doc.text(formatAmount(deliveryData.tva || 0), 190, yPos, { align: 'right' });
      yPos += 6;

      if (deliveryData.timbre && deliveryData.timbre > 0) {
        doc.text('Timbre:', 120, yPos);
        doc.text(formatAmount(deliveryData.timbre), 190, yPos, { align: 'right' });
        yPos += 6;
      }

      if (deliveryData.autre_taxe && deliveryData.autre_taxe > 0) {
        doc.text('Autres taxes:', 120, yPos);
        doc.text(formatAmount(deliveryData.autre_taxe), 190, yPos, { align: 'right' });
        yPos += 6;
      }

      // Total TTC
      yPos += 2;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('TOTAL TTC:', 120, yPos);
      doc.text(formatAmount(totalTTC), 190, yPos, { align: 'right' });

      // Amount in words - AJOUT√â POUR LES BONS DE LIVRAISON
      yPos += 15;
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      
      // Ligne de s√©paration avant le montant en lettres
      doc.line(20, yPos - 5, 190, yPos - 5);
      
      doc.text('Arr√™t√© le pr√©sent bon de livraison √† la somme de :', 20, yPos);
      yPos += 12; // ‚Üê Plus d'espace (√©tait 8)

      const amountWords = numberToWords(totalTTC);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      
      // Encadrer le montant en lettres avec plus d'espace
      const textWidth = doc.getTextWidth(amountWords);
      const boxWidth = Math.min(textWidth + 16, 170); // ‚Üê Plus de padding (√©tait 10)
      const boxHeight = 16; // ‚Üê Plus haut (√©tait 12)
      
      doc.rect(20, yPos - 10, boxWidth, boxHeight); // ‚Üê Ajust√© pour la nouvelle hauteur
      doc.text(amountWords, 28, yPos - 2, { // ‚Üê Plus de marge √† gauche (√©tait 25)
        maxWidth: 160
      });
      
      yPos += 18; // ‚Üê Plus d'espace apr√®s le cadre (√©tait 15)
    }

    // Note importante pour BL
    yPos += 15;
    doc.setFontSize(8);
    doc.setFont('helvetica', 'italic');
    doc.text('Note: Ce bon de livraison ne constitue pas une facture.', 20, yPos);
    doc.text('La facturation sera √©tablie s√©par√©ment.', 20, yPos + 4);

    // Signatures
    yPos += 20;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text('Signature Livreur:', 20, yPos);
    doc.text('Signature Client:', 130, yPos);

    yPos += 20;
    doc.line(20, yPos, 80, yPos);
    doc.line(130, yPos, 190, yPos);

    return doc;
  }

  /**
   * Generate small delivery note PDF (format r√©duit)
   */
  async generateSmallDeliveryNote(deliveryData: DeliveryNoteData, tenant?: string): Promise<jsPDF> {
    const doc = new jsPDF();
    let yPos = 20;

    // Get company info from database for the specific tenant
    const companyInfo = await this.getCompanyInfo(tenant);

    // Title - Plus compact
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text(`Bon N¬∞: ${deliveryData.nfact}`, 105, yPos, { align: 'center' });
    yPos += 15;

    // Date et client sur la m√™me ligne
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Date: ${new Date(deliveryData.date_fact).toLocaleDateString('fr-FR')}`, 20, yPos);
    doc.text(`Code client: ${deliveryData.client.raison_sociale}`, 120, yPos);
    yPos += 20;

    // Table header - Plus compact
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.text('Code', 20, yPos);
    doc.text('D√©signation', 50, yPos);
    doc.text('Qt√©', 130, yPos, { align: 'center' });
    doc.text('P.U.', 155, yPos, { align: 'center' });
    doc.text('Total', 180, yPos, { align: 'center' });

    // Line under header
    yPos += 2;
    doc.line(20, yPos, 190, yPos);
    yPos += 5;

    // Table rows - Plus compact
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);

    deliveryData.detail_bl.forEach((item) => {
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      }

      doc.text(item.article.narticle.substring(0, 6), 20, yPos);
      doc.text(item.article.designation.substring(0, 20), 50, yPos);
      doc.text(formatQuantity(item.qte), 135, yPos, { align: 'right' });
      
      if (item.prix) {
        doc.text(formatNumber(item.prix), 165, yPos, { align: 'right' });
      }
      
      if (item.total_ligne) {
        doc.text(formatNumber(item.total_ligne), 190, yPos, { align: 'right' });
      }

      yPos += 5;
    });

    // Totaux complets - Format r√©duit
    yPos += 10;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    
    if (deliveryData.montant_ht !== undefined) {
      doc.text('Sous-total HT:', 120, yPos);
      doc.text(formatAmount(deliveryData.montant_ht || 0), 190, yPos, { align: 'right' });
      yPos += 5;
    }
    
    if (deliveryData.tva !== undefined && deliveryData.tva > 0) {
      doc.text('TVA:', 120, yPos);
      doc.text(formatAmount(deliveryData.tva || 0), 190, yPos, { align: 'right' });
      yPos += 5;
    }
    
    // Total TTC en gras - CORRECTION: Conversion num√©rique pour √©viter la concat√©nation
    let totalTTC = deliveryData.montant_ttc;
    if (totalTTC === undefined || totalTTC === null || isNaN(totalTTC)) {
      totalTTC = parseFloat(deliveryData.montant_ht?.toString() || '0') + 
                 parseFloat(deliveryData.tva?.toString() || '0') + 
                 parseFloat(deliveryData.timbre?.toString() || '0') + 
                 parseFloat(deliveryData.autre_taxe?.toString() || '0');
    }
    
    // S'assurer que totalTTC est un nombre valide
    totalTTC = parseFloat(totalTTC.toString()) || 0;
    
    if (totalTTC > 0) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.text('TOTAL TTC:', 120, yPos);
      doc.text(formatAmount(totalTTC), 190, yPos, { align: 'right' });
    }

    return doc;
  }

  /**
   * Generate ticket receipt PDF (format ticket de caisse)
   */
  async generateTicketReceipt(deliveryData: DeliveryNoteData, tenant?: string): Promise<jsPDF> {
    // Get company info from database for the specific tenant
    const companyInfo = await this.getCompanyInfo(tenant);

    // Format ticket - plus petit (80mm de large)
    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: [80, 200] // 80mm de large, hauteur variable
    });
    
    let yPos = 10;

    // En-t√™te entreprise - Centr√©
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text(companyInfo.name, 40, yPos, { align: 'center' });
    yPos += 5;
    
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.text(companyInfo.phone, 40, yPos, { align: 'center' });
    yPos += 10;

    // Num√©ro de bon et date
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.text(`Bon N¬∞: ${deliveryData.nfact}`, 40, yPos, { align: 'center' });
    yPos += 4;
    
    doc.setFont('helvetica', 'normal');
    doc.text(`Date: ${new Date(deliveryData.date_fact).toLocaleDateString('fr-FR')}`, 40, yPos, { align: 'center' });
    yPos += 4;
    doc.text(`Client: ${deliveryData.client.raison_sociale}`, 40, yPos, { align: 'center' });
    yPos += 8;

    // Ligne de s√©paration
    doc.line(5, yPos, 75, yPos);
    yPos += 5;

    // En-t√™tes colonnes - Format ticket avec meilleur espacement
    doc.setFontSize(7);
    doc.setFont('helvetica', 'bold');
    doc.text('D√©signation', 5, yPos);
    doc.text('Qt√©', 45, yPos, { align: 'center' });
    doc.text('P.U.', 55, yPos, { align: 'center' });
    doc.text('Total', 72, yPos, { align: 'right' });
    yPos += 3;

    // Ligne sous en-t√™tes
    doc.line(5, yPos, 75, yPos);
    yPos += 3;

    // Articles - Format tr√®s compact
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(6);

    deliveryData.detail_bl.forEach((item) => {
      // D√©signation sur une ligne
      const designation = item.article.designation.substring(0, 20); // Raccourci pour laisser plus de place
      doc.text(designation, 5, yPos);
      yPos += 3;

      // Quantit√©, prix, total sur la ligne suivante avec meilleur espacement
      doc.text(formatQuantity(item.qte), 45, yPos, { align: 'center' });
      
      if (item.prix) {
        doc.text(formatNumber(item.prix, 2), 55, yPos, { align: 'center' });
      }
      
      if (item.total_ligne) {
        doc.text(formatNumber(item.total_ligne, 2), 72, yPos, { align: 'right' });
      }

      yPos += 4;
    });

    // Ligne de s√©paration avant total
    yPos += 2;
    doc.line(5, yPos, 75, yPos);
    yPos += 4;

    // Totaux complets
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7);
    
    if (deliveryData.montant_ht !== undefined) {
      doc.text('Sous-total HT:', 20, yPos);
      doc.text(formatAmount(deliveryData.montant_ht || 0), 72, yPos, { align: 'right' });
      yPos += 4;
    }
    
    if (deliveryData.tva !== undefined && deliveryData.tva > 0) {
      doc.text('TVA:', 20, yPos);
      doc.text(formatAmount(deliveryData.tva || 0), 72, yPos, { align: 'right' });
      yPos += 4;
    }
    
    // Total TTC en gras - CORRECTION: Conversion num√©rique pour √©viter la concat√©nation
    let totalTTC = deliveryData.montant_ttc;
    if (totalTTC === undefined || totalTTC === null || isNaN(totalTTC)) {
      totalTTC = parseFloat(deliveryData.montant_ht?.toString() || '0') + 
                 parseFloat(deliveryData.tva?.toString() || '0') + 
                 parseFloat(deliveryData.timbre?.toString() || '0') + 
                 parseFloat(deliveryData.autre_taxe?.toString() || '0');
    }
    
    // S'assurer que totalTTC est un nombre valide
    totalTTC = parseFloat(totalTTC.toString()) || 0;
    
    if (totalTTC > 0) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.text('TOTAL TTC:', 20, yPos);
      doc.text(formatAmount(totalTTC), 72, yPos, { align: 'right' });
      yPos += 8;
    }

    // Message de remerciement
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7);
    doc.text('Merci de votre visite', 40, yPos, { align: 'center' });

    return doc;
  }

  /**
   * Generate proforma invoice PDF
   */
  async generateProforma(invoiceData: InvoiceData, tenant?: string): Promise<jsPDF> {
    // Generate a custom proforma PDF instead of modifying invoice PDF
    const doc = new jsPDF();
    let yPos = 20;

    // Get company info from database for the specific tenant
    const companyInfo = await this.getCompanyInfo(tenant);

    // Header - Title (PROFORMA instead of FACTURE)
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(220, 20, 60); // Rouge fonc√© pour PROFORMA
    doc.text('FACTURE PROFORMA', 105, yPos, { align: 'center' });
    doc.setTextColor(0, 0, 0); // Retour au noir
    yPos += 10;

    // Line under title
    doc.setLineWidth(0.5);
    doc.line(20, yPos, 190, yPos);
    yPos += 15;

    // Proforma info (right side) 
    let rightSideY = yPos;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Proforma N: ${invoiceData.nfact}`, 140, rightSideY);
    rightSideY += 5;
    doc.text(`Date: ${new Date(invoiceData.date_fact).toLocaleDateString('fr-FR')}`, 140, rightSideY);
    rightSideY += 10; // Espacement avant les infos client
    
    // Client info (c√¥t√© droit, en dessous de la date)
    doc.setFont('helvetica', 'bold');
    doc.text('Client:', 140, rightSideY);
    rightSideY += 5;
    doc.setFont('helvetica', 'normal');
    doc.text(invoiceData.client.raison_sociale, 140, rightSideY);
    rightSideY += 5;

    if (invoiceData.client.adresse) {
      doc.text(invoiceData.client.adresse, 140, rightSideY);
      rightSideY += 5;
    }

    if (invoiceData.client.nif) {
      doc.text(`NIF: ${invoiceData.client.nif}`, 140, rightSideY);
      rightSideY += 5;
    }
    
    // Revenir au d√©but pour les infos entreprise (c√¥t√© gauche)
    yPos = 45; // Position fixe pour les infos entreprise
    
    // Company info (left side) - Limiter la largeur pour √©viter chevauchement avec droite
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    // Limiter le texte √† 100 caract√®res pour √©viter d√©bordement sur la droite
    const companyName = companyInfo.name.length > 35 ? companyInfo.name.substring(0, 35) + '...' : companyInfo.name;
    doc.text(companyName, 20, yPos);
    yPos += 5;
    
    // Add domain of activity if available
    if (companyInfo.domaine_activite) {
      doc.setFontSize(8);
      doc.setFont('helvetica', 'italic');
      const domaine = companyInfo.domaine_activite.length > 40 ? companyInfo.domaine_activite.substring(0, 40) + '...' : companyInfo.domaine_activite;
      doc.text(domaine, 20, yPos);
      yPos += 4;
      if (companyInfo.sous_domaine) {
        const sousDomaine = companyInfo.sous_domaine.length > 40 ? companyInfo.sous_domaine.substring(0, 40) + '...' : companyInfo.sous_domaine;
        doc.text(sousDomaine, 20, yPos);
        yPos += 4;
      }
    }
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    // Limiter l'adresse pour √©viter d√©bordement
    const address = companyInfo.address.length > 45 ? companyInfo.address.substring(0, 45) + '...' : companyInfo.address;
    doc.text(address, 20, yPos);
    yPos += 5;
    doc.text(`T√©l: ${companyInfo.phone}`, 20, yPos);
    yPos += 5;

    if (companyInfo.tel_port) {
      doc.text(`Mobile: ${companyInfo.tel_port}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.email) {
      const email = companyInfo.email.length > 35 ? companyInfo.email.substring(0, 35) + '...' : companyInfo.email;
      doc.text(`Email: ${email}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.nif || companyInfo.ident_fiscal) {
      const nif = (companyInfo.nif || companyInfo.ident_fiscal);
      doc.text(`NIF: ${nif}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.rc) {
      doc.text(`RC: ${companyInfo.rc}`, 20, yPos);
      yPos += 5;
    }

    if (companyInfo.art) {
      doc.text(`Art: ${companyInfo.art}`, 20, yPos);
      yPos += 5;
    }

    // Sauvegarder la position finale des infos entreprise
    let companyEndY = yPos;

    // Table header - Position apr√®s les infos entreprise ET client (c√¥t√© droit)
    // Prendre la position la plus basse entre infos entreprise et infos client
    yPos = Math.max(companyEndY + 15, rightSideY + 10);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.text('Code', 20, yPos);
    doc.text('Designation', 45, yPos);
    doc.text('Qte', 105, yPos, { align: 'center' });
    doc.text('P.U.', 130, yPos, { align: 'center' });
    doc.text('TVA', 155, yPos, { align: 'center' });
    doc.text('Total', 180, yPos, { align: 'center' });

    // Line under header
    yPos += 2;
    doc.line(20, yPos, 190, yPos);
    yPos += 5;

    // Table rows
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);

    invoiceData.detail_fact.forEach((item) => {
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      }

      doc.text(item.article.narticle.substring(0, 8), 20, yPos);
      doc.text(item.article.designation.substring(0, 25), 45, yPos);
      doc.text(formatQuantity(item.qte), 110, yPos, { align: 'right' });
      doc.text(formatNumber(item.prix), 140, yPos, { align: 'right' });
      doc.text(formatPercentage(item.tva), 165, yPos, { align: 'right' });
      doc.text(formatNumber(item.total_ligne), 190, yPos, { align: 'right' });

      yPos += 6;
    });

    // Totals section
    yPos += 10;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');

    const totalTTC = invoiceData.montant_ht + invoiceData.tva + invoiceData.timbre + invoiceData.autre_taxe;

    doc.text('Sous-total HT:', 120, yPos);
    doc.text(formatAmount(invoiceData.montant_ht), 190, yPos, { align: 'right' });
    yPos += 6;

    doc.text('TVA:', 120, yPos);
    doc.text(formatAmount(invoiceData.tva), 190, yPos, { align: 'right' });
    yPos += 6;

    if (invoiceData.timbre > 0) {
      doc.text('Timbre:', 120, yPos);
      doc.text(formatAmount(invoiceData.timbre), 190, yPos, { align: 'right' });
      yPos += 6;
    }

    if (invoiceData.autre_taxe > 0) {
      doc.text('Autres taxes:', 120, yPos);
      doc.text(formatAmount(invoiceData.autre_taxe), 190, yPos, { align: 'right' });
      yPos += 6;
    }

    // Total TTC
    yPos += 2;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('TOTAL TTC:', 120, yPos);
    doc.text(formatAmount(totalTTC), 190, yPos, { align: 'right' });

    // Amount in words - CONFORME √Ä LA R√âGLEMENTATION
    yPos += 15;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    
    // Ligne de s√©paration avant le montant en lettres
    doc.line(20, yPos - 5, 190, yPos - 5);
    
    doc.text('Arr√™t√© la pr√©sente proforma √† la somme de :', 20, yPos);
    yPos += 12;

    const amountWords = numberToWords(totalTTC);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    
    // Encadrer le montant en lettres avec plus d'espace
    const textWidth = doc.getTextWidth(amountWords);
    const boxWidth = Math.min(textWidth + 16, 170);
    const boxHeight = 16;
    
    doc.rect(20, yPos - 10, boxWidth, boxHeight);
    doc.text(amountWords, 28, yPos - 2, {
      maxWidth: 160
    });
    
    yPos += 18;

    // Note sp√©ciale pour proforma
    yPos += 10;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'italic');
    doc.setTextColor(220, 20, 60); // Rouge fonc√©
    doc.text('Note: Cette proforma n\'a aucune valeur comptable.', 20, yPos);
    doc.text('Elle constitue uniquement une proposition commerciale.', 20, yPos + 4);
    doc.setTextColor(0, 0, 0); // Retour au noir

    // Signature
    yPos += 20;
    doc.setFont('helvetica', 'normal');
    doc.text('Signature et Cachet', 140, yPos);

    return doc;
  }
}
